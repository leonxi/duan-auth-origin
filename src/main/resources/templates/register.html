<!doctype html>
<html lang="zh-cmn-Hans">
<head>
<!-- Required meta tags -->
<meta charset="utf-8">
<meta name="viewport"
  content="width=device-width, initial-scale=1, shrink-to-fit=no">

<!-- Bootstrap CSS -->
<link rel="stylesheet" href="/auo/static/bootstrap/css/bootstrap.min.css"
  integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
  crossorigin="anonymous">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
<title>短应用&trade; 注册新用户</title>
</head>
<body>
<div class="container-fluid">
<p></p>
<div class="row">
  <div class="col-12 d-flex justify-content-center">
  <h1>短应用&trade; 注册新用户</h1>
  </div>
</div>
<p></p>
<div class="row">
<div class="d-flex justify-content-center w-100 align-items-center maxheight">
  <form>
    <div class="form-group">
      <label for="useremail">邮件地址</label>
      <input type="email" class="form-control" id="useremail" aria-describedby="emailHelp" placeholder="sample@email.com" required>
      <small id="emailHelp" class="form-text text-muted">请使用常用的邮件地址注册, 你可以通过该邮件地址取回短应用&trade;的密码.</small>
    </div>
    <div class="form-group">
      <label for="username">姓名</label>
      <input type="text" class="form-control" id="username" required>
    </div>
    <div class="form-group">
      <label for="userpassword">密码</label>
      <input type="password" class="form-control" id="userpassword" required>
    </div>
    <div class="form-group">
      <label for="userpasswordconfirm">确认密码</label>
      <input type="password" class="form-control" id="userpasswordconfirm" required>
    </div>
    <button type="button" id="register" class="btn btn-primary">注册</button>
  </form>
</div>
</div>
</div>
<script src="/auo/static/jquery/js/jquery.min.js"></script>
<script src="/auo/static/bootstrap/js/bootstrap.min.js"
  integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
  crossorigin="anonymous"></script>
<script type="text/javascript">
$(function() {
  var autoheight = function() {
    var winHeight = $(window).innerHeight();
    var exactHeight = 0;
    var siblings = $(".maxheight").parent().siblings();
    
    for (var si in siblings) {
      var sibling = siblings[si];
      if (sibling.nodeName !== 'NAV' 
          && sibling.nodeName !== 'DIV'
            && sibling.nodeName !== 'P') {
        continue;
      }
      
      exactHeight += ($(sibling).outerHeight() === undefined ? 0 : $(sibling).outerHeight());
    }
    
    $(".maxheight").css("height", (winHeight - exactHeight - (winHeight / 4)) + "px");
  };
  
  $(window).resize(autoheight);
  autoheight();
  
  var regEmail = /([\w-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)/;

  
  var registerformcheck = function(form) {
    var useremail = $(form).find("input#useremail").val();
    var username = $(form).find("input#username").val();
    var userpassword = $(form).find("input#userpassword").val();
    var userpasswordconfirm = $(form).find("input#userpasswordconfirm").val();
    var checked = true;
    
    if (useremail === undefined || useremail === '' || regEmail.test(useremail) == false) {
      $(form).find("input#useremail").siblings('div.invalid-feedback').remove();
      $(form).find("input#useremail").addClass("is-invalid");
      $(form).find("input#useremail").after("<div class=\"invalid-feedback\">" +
          "请输入正确的电子邮件地址, 例如: sample@email.com" +
          "</div>");
      checked = false;
    } else {
      $(form).find("input#useremail").siblings('div.invalid-feedback').remove();
      $(form).find("input#useremail").removeClass("is-invalid");
    }
    
    if (username === undefined || username === '') {
      $(form).find("input#username").siblings('div.invalid-feedback').remove();
      $(form).find("input#username").addClass("is-invalid");
      $(form).find("input#username").after("<div class=\"invalid-feedback\">" +
          "请输入姓名" +
          "</div>");
      checked = false;
    } else {
      $(form).find("input#username").siblings('div.invalid-feedback').remove();
      $(form).find("input#username").removeClass("is-invalid");
    }
    
    if (userpassword === undefined || userpassword === '') {
      $(form).find("input#userpassword").siblings('div.invalid-feedback').remove();
      $(form).find("input#userpassword").addClass("is-invalid");
      $(form).find("input#userpassword").after("<div class=\"invalid-feedback\">" +
          "请输入密码" +
          "</div>");
      checked = false;
    } else {
      $(form).find("input#userpassword").siblings('div.invalid-feedback').remove();
      $(form).find("input#userpassword").removeClass("is-invalid");
    }
    
    if (userpasswordconfirm === undefined || userpasswordconfirm === '') {
      $(form).find("input#userpasswordconfirm").siblings('div.invalid-feedback').remove();
      $(form).find("input#userpasswordconfirm").addClass("is-invalid");
      $(form).find("input#userpasswordconfirm").after("<div class=\"invalid-feedback\">" +
          "请输入确认密码" +
          "</div>");
      checked = false;
    } else {
      $(form).find("input#userpasswordconfirm").siblings('div.invalid-feedback').remove();
      $(form).find("input#userpasswordconfirm").removeClass("is-invalid");
    }
    
    if (userpassword !== undefined && userpassword !== ''
        && userpasswordconfirm !== undefined && userpasswordconfirm !== ''
        && userpassword !== userpasswordconfirm) {
      $(form).find("input#userpasswordconfirm").siblings('div.invalid-feedback').remove();
      $(form).find("input#userpasswordconfirm").addClass("is-invalid");
      $(form).find("input#userpasswordconfirm").after("<div class=\"invalid-feedback\">" +
          "确认密码不正确, 请重新输入" +
          "</div>");
      checked = false;
    }
    
    return checked;
  }
  
  var loginform = function(form) {
    $(form).find("button#register").bind("click", function() {
      var useremail = $(form).find("input#useremail").val();
      var username = $(form).find("input#username").val();
      var userpassword = $(form).find("input#userpassword").val();

      var userform = {
          useremail: useremail,
          username: username,
          userpassword: userpassword
      };
      
      if (registerformcheck(form)) {
        $.ajax({
          url: "/auo/doregister",
          type: "post",
          dataType: "json",
          data: JSON.stringify(userform),
          contentType: "application/json;charset=UTF-8",
          success: function(resp) {
            if (resp.openid !== undefined) {
              location.href = "/";
            } else {
              $(form).find("input#useremail").siblings('div.invalid-feedback').remove();
              $(form).find("input#useremail").addClass("is-invalid");
              $(form).find("input#useremail").after("<div class=\"invalid-feedback\">" +
                  "邮件地址已存在" +
                  "</div>");
            }
          }
        });
      }
    });
  }
  
  loginform('form');
});
</script>
</body>
</html>